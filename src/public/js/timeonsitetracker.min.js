/**@preserve
 * Commercial License
 *
 * TimeOnSiteTracker.js - Measure your user's Time on site accurately.
 * 
 * Copyright (C) 2016 - 2026 Saleem Khan
 *
 * License key: {your-license-key-here}
 *
 * This is copyrighted software and requires you buy commericial license
 * before using it. Replace {your-license-key-here} with the licence key 
 * that you buy before starting to use this software. 
 * 
 * visit https://github.com/saleemkce/timeonsite/blob/master/LICENSE.md to learn more about 
 * license terms. 
 */
/**@preserve
 * Time on Site Tracker (TOS)
 * This file tracks time spent on page by user session.
 * It exposes getTimeOnPage() API which gives back time spent so far on page. Call any time to get current page's TOP
 * Provides suppport for blacklisting URL from tracking TOS
 * Measure your user's interaction with site directly and accurately.
 */
var TimeOnSiteTracker=function(a){this.varyingStartTime=new Date,this.pageEntryTime=this.getDateTime(),this.activityStartTime=null,this.totalTimeSpent=0,this.returnInSeconds=!1,this.isTimeOnSiteAllowed=!0,this.callback=null,this.timeSpentArr=[],this.storeInLocalStorage=!1,this.storageSupported=!1,this.TOSDateKeysHolder="TimeOnSiteDateKeys",this.TOSDayKeyPrefix="TOS_",this.activity={},this.activity.activityStarted=!1,this.config=a,this.xhr=null,this.timeOnSite=0,this.isFlushSampleDataIOS=!1,this.TOSSessionKey=null,this.TOSId=this.createTOSId(),this.customData=null,this.TOSUserId="anonymous",this.anonymousTimerId=null,this.sessionStateChangeTimerId=null,this.fileIntegrityCode="ae4c20f53073125154d68d59c1818f8b",this.sessionValidity={anonymous:15,oneDayInSecs:86400,oneMonthInSeconds:2592e3},this.TOSCookie={path:null,domain:null},this.request={url:"",headers:[]},this.isRequestHeadersAvailable=!1,this.developerMode=!1,this.TOS_CONST={TOSSessionKey:"TOSSessionKey",TOSSessionDuration:"TOSSessionDuration",TOSUserId:"TOSUserId",TOSAnonSessionRefresh:"TOSAnonSessionRefresh",TOSIsCookieSupported:"TOSIsCookieSupported",TOSExtendSessionDuration:"TOSExtendSessionDuration"},this.version="1.2.0",this.initialize(this.config)};TimeOnSiteTracker.prototype.initialize=function(a){var b=this;if(a&&a.developerMode&&(this.developerMode=!0,console.info("Timeonsitetracker.js loaded version : "+this.getVersion())),a&&void 0===a.trackHistoryChange){if(this.initBlacklistUrlConfig(a),!this.isTimeOnSiteAllowed)return}else a&&a.trackHistoryChange&&!0===a.trackHistoryChange&&a.blacklistUrl&&console.warn("Blacklisting pages not available in single-page application.");if(this.isIOS()?(console.warn("No unload window for IOS devices but still handled by tracker!"),this.handleIOSDevicesWindowUnload()):this.bindWindowUnload(),this.bindWindowFocus(),a&&a.trackBy&&"seconds"===a.trackBy.toLowerCase()&&(this.returnInSeconds=!0),a&&a.callback&&(this.callback=a.callback),a&&a.trackHistoryChange&&!0===a.trackHistoryChange&&this.bindWindowHistory(),this.TOSCookie.customCookieString="",this.TOSCookie.PATH_DOMAIN_ENABLED=!1,a&&a.TOSCookie?(a.TOSCookie.path&&"/"!=a.TOSCookie.path?(this.TOSCookie.customCookieString+="path="+this.validateCookieInput(a.TOSCookie.path)+";",this.TOSCookie.PATH_DOMAIN_ENABLED=!0):this.TOSCookie.customCookieString+="path=/;",a.TOSCookie.domain&&(this.TOSCookie.customCookieString+="domain="+this.validateCookieInput(a.TOSCookie.domain)+";",this.TOSCookie.PATH_DOMAIN_ENABLED=!0)):this.TOSCookie.customCookieString+="path=/;",this.TOSCookie.customCookieString+="SameSite=Lax;","https:"==location.protocol&&(this.TOSCookie.customCookieString+="secure;"),!0===this.TOSCookie.PATH_DOMAIN_ENABLED){var c=this.getMD5Hash(this.TOSCookie.customCookieString);this.TOS_CONST.TOSSessionKey=this.TOS_CONST.TOSSessionKey+"_"+c,this.TOS_CONST.TOSSessionDuration=this.TOS_CONST.TOSSessionDuration+"_"+c,this.TOS_CONST.TOSUserId=this.TOS_CONST.TOSUserId+"_"+c,this.TOS_CONST.TOSAnonSessionRefresh=this.TOS_CONST.TOSAnonSessionRefresh+"_"+c,this.TOS_CONST.TOSIsCookieSupported=this.TOS_CONST.TOSIsCookieSupported+"_"+c,this.TOS_CONST.TOSExtendSessionDuration=this.TOS_CONST.TOSExtendSessionDuration+"_"+c}a&&a.request&&a.request.url&&(this.request.url=a.request.url,this.isURLValid(this.request.url),a.request.headers&&a.request.headers instanceof Array&&(this.isRequestHeadersAvailable=!0,this.request.headers=a.request.headers)),this.isLocalStorageEnabled()?this.storageSupported=!0:console.warn("Session/Local storage not supported by this browser."),a&&a.request&&a.request.url&&this.storageSupported&&null===this.callback&&(this.storeInLocalStorage=!0,this.processDataInLocalStorage()),a&&a.request&&a.request.url||null!==this.callback||console.warn("TOS data won't be available because neither callback nor local storage option given!"),a&&a.request&&a.request.url&&this.callback&&console.warn("Both callback and local storage options given. Callback function takes precedence. Give either one!"),a&&a.isIOSDemo&&(this.isFlushSampleDataIOS=!0),this.checkCookieSupport(),this.monitorUser(),this.monitorSession(),this.monitorSessionStateChange(),this.developerMode&&console.info("TOS cookie created with path/domain : "+this.TOSCookie.customCookieString),this.fileValidation(),this.developerMode&&setInterval(function(){b.showProgress()},1e3),this.flushDemoDataIOS(),this.stampImprint()},TimeOnSiteTracker.prototype.getTimeDiff=function(a,b){return b-a},TimeOnSiteTracker.prototype.validateCookieInput=function(a){return a&&a.length&&";"===a.substring(a.length-1)&&(a=a.substring(0,a.length-1)),a},TimeOnSiteTracker.prototype.isIOS=function(){return/iPad|iPhone|iPod/i.test(navigator.platform)&&!window.MSStream},TimeOnSiteTracker.prototype.handleIOSDevicesWindowUnload=function(){var a=this;this.isIOS()&&(console.log("IOS: IOS device loaded!"),this.handleDateKeysInit(),setInterval(function(){a.monitorSession();var b=a.getTimeOnPage();b.exitTime=a.getDateTime(),a.isTimeOnSiteAllowed&&("function"==typeof a.callback?console.warn("IOS: Real-time callback not supported due to poor unload event support!"):a.storeInLocalStorage&&(console.log("IOS: UPSERT to LS called at "+new Date),a.upsertToLocalStorageIOS(b)))},1e3))},TimeOnSiteTracker.prototype.arrayAggregate=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b},TimeOnSiteTracker.prototype.isURLValid=function(a){/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(a)||console.error('Given URL is not in valid format : "'+a+'"')},TimeOnSiteTracker.prototype.createTOSId=function(){return(new Date).valueOf()*Math.floor(9010*Math.random()+1e3)},TimeOnSiteTracker.prototype.millisecondToSecond=function(a){return a/1e3},TimeOnSiteTracker.prototype.secondToDuration=function(a){return parseInt(a/86400)+"d "+new Date(a%86400*1e3).toUTCString().replace(/.*(\d{2}):(\d{2}):(\d{2}).*/,"$1h $2m $3s")},TimeOnSiteTracker.prototype.getDateTime=function(){return(new Date).toISOString().substr(0,23).replace("T"," ")},TimeOnSiteTracker.prototype.getVersion=function(){return this.version},TimeOnSiteTracker.prototype.getTOSSessionKey=function(){return this.TOSSessionKey},TimeOnSiteTracker.prototype.createTOSSessionKey=function(){var a=new Date,b=a.getMilliseconds()+"";return Math.floor(9010*Math.random()+1e3)+""+ ++a+b+Math.floor(90*Math.random()+10)},TimeOnSiteTracker.prototype.startSession=function(a){a&&a.toString().length?(this.monitorSession(),this.processTOSData(),this.setCookie(this.TOS_CONST.TOSAnonSessionRefresh,0,this.sessionValidity.oneDayInSecs),this.TOSUserId=a,this.setCookie(this.TOS_CONST.TOSUserId,a,this.sessionValidity.oneDayInSecs),this.createNewSession()):console.warn("Please give proper userId to start TOS session.")},TimeOnSiteTracker.prototype.endSession=function(){var a=this;this.monitorSession(),this.processTOSData(),this.removeCookie(this.TOS_CONST.TOSUserId),this.removeCookie(this.TOS_CONST.TOSSessionKey),this.removeCookie(this.TOS_CONST.TOSSessionDuration),setTimeout(function(){a.removeCookie(a.TOS_CONST.TOSExtendSessionDuration)},500),this.TOSUserId="anonymous",this.createNewSession("anonymous")},TimeOnSiteTracker.prototype.showProgress=function(){var a=this.getTimeOnPage();console.log("TimeOnPage(TOP): "+a.timeOnPage+" "+a.timeOnPageTrackedBy)},TimeOnSiteTracker.prototype.stampImprint=function(){var a=["#008000","#a900ff","#0400f5","#d60000","#000000","#ffffff"],b=Math.floor(6*Math.random()+0);console.log("%cTimeOnSite Tracker","font-size: 40px; font-family: Georgia; color: "+a[b]+";font-style:italic;text-shadow: 0 1px 0 #999999, 0 2px 0 #888888,0 3px 0 #777777, 0 4px 0 #666666,0 5px 0 #555555, 0 6px 0 #444444,0 7px 0 #333333, 0 8px 7px rgba(0, 0, 0, 0.4),0 9px 10px rgba(0, 0, 0, 0.2)")},TimeOnSiteTracker.prototype.checkCookieSupport=function(){var a=this;this.getCookie(this.TOS_CONST.TOSIsCookieSupported)||(this.setCookie(this.TOS_CONST.TOSIsCookieSupported,"yes",this.sessionValidity.oneMonthInSeconds),setTimeout(function(){a.getCookie(a.TOS_CONST.TOSIsCookieSupported)||(console.error("Setting cookie not supported by this browser. Exiting TOS..."),a.isTimeOnSiteAllowed=!1)},2e3))},TimeOnSiteTracker.prototype.extendSession=function(a){if("number"==typeof a&&this.getCookie(this.TOS_CONST.TOSUserId)){var b=parseInt(a),c=this.getSessionDuration();c=c?parseInt(c):0,this.setCookie(this.TOS_CONST.TOSUserId,this.TOSUserId,b),this.setCookie(this.TOS_CONST.TOSSessionKey,this.TOSSessionKey,b),this.setCookie(this.TOS_CONST.TOSSessionDuration,c,b),this.setCookie(this.TOS_CONST.TOSAnonSessionRefresh,0,b),this.setCookie(this.TOS_CONST.TOSExtendSessionDuration,b,b);var d=new Date;d.setTime(d.getTime()+1e3*b),console.info("Session extended till "+new Date(d))}else console.warn("Either anonymous session detected or given input seconds is not a number!")},TimeOnSiteTracker.prototype.initBlacklistUrlConfig=function(a){a&&a.blacklistUrl&&(a.blacklistUrl instanceof Array||console.warn("blacklistUrl configuration must be of type array"),a.blacklistUrl instanceof Array&&a.blacklistUrl.length&&(this.checkBlacklistUrl(a.blacklistUrl)||(console.info("This page is blacklisted for tracking TOS!"),this.isTimeOnSiteAllowed=!1)))},TimeOnSiteTracker.prototype.monitorUser=function(){var a=this.getCookie(this.TOS_CONST.TOSUserId),b=this.getCookie(this.TOS_CONST.TOSSessionKey);a&&a.length?(this.TOSSessionKey=b&&b.length?b:this.TOSSessionKey,this.TOSUserId=a,this.developerMode&&console.info("Authenticated user. TOSSessionKey: "+this.TOSSessionKey+" & TOSUserId: "+this.TOSUserId)):b&&!a?(this.developerMode&&console.info("Anonymous user. TOSSessionKey: "+b),this.TOSSessionKey=b&&b.length?b:this.TOSSessionKey,this.renewSession()):this.createNewSession("anonymous")},TimeOnSiteTracker.prototype.monitorSession=function(){var a,b=this.getSessionDuration(),c=this.getCookie(this.TOS_CONST.TOSSessionKey),d=this.getCookie(this.TOS_CONST.TOSUserId),e=0;if(c||(console.error("Caution! sessionKey empty at : "+new Date),c=this.reviveBrokenSession(),this.developerMode&&alert("Caution! sessionKey empty at : "+new Date)),a=this.getTimeOnPage(),b=parseInt(b),this.isIOS()?(e=this.getTimeOnSiteCurrentSessionIOS(),console.log("IOS: periodic updated duration value : "+e)):e=a.timeOnPage+b,this.TOSSessionKey=c&&c.length?c:this.TOSSessionKey,d&&d.length){var f=this.getCookie(this.TOS_CONST.TOSExtendSessionDuration);f=f?parseInt(f):this.sessionValidity.oneDayInSecs,this.setCookie(this.TOS_CONST.TOSSessionDuration,e,f)}else this.setCookie(this.TOS_CONST.TOSSessionDuration,e,this.sessionValidity.oneDayInSecs);!this.returnInSeconds&&e<1e3||(this.timeOnSite=e)},TimeOnSiteTracker.prototype.createNewSession=function(a){this.setCookie(this.TOS_CONST.TOSSessionDuration,0,this.sessionValidity.oneDayInSecs),this.TOSId=this.createTOSId(),this.TOSSessionKey=this.createTOSSessionKey(),"anonymous"===a?(this.setCookie(this.TOS_CONST.TOSSessionKey,this.TOSSessionKey,this.sessionValidity.anonymous),this.setCookie(this.TOS_CONST.TOSAnonSessionRefresh,1,this.sessionValidity.oneDayInSecs),this.renewSession()):(this.anonymousTimerId&&clearInterval(this.anonymousTimerId),this.setCookie(this.TOS_CONST.TOSSessionKey,this.TOSSessionKey,this.sessionValidity.oneDayInSecs)),this.timeOnSite=0},TimeOnSiteTracker.prototype.renewSession=function(){var a,b=this;this.anonymousTimerId=setInterval(function(){1==(a=b.getCookie(b.TOS_CONST.TOSAnonSessionRefresh))&&(b.setCookie(b.TOS_CONST.TOSSessionKey,b.TOSSessionKey,b.sessionValidity.anonymous),b.developerMode&&console.log("Session renewed at : "+new Date))},1e3)},TimeOnSiteTracker.prototype.monitorSessionStateChange=function(){var a,b,c=this;this.sessionStateChangeTimerId=setInterval(function(){a=c.getCookie(c.TOS_CONST.TOSSessionKey),b=c.getCookie(c.TOS_CONST.TOSUserId),a&&(c.TOSSessionKey=a),c.TOSUserId=b||"anonymous"},1500)},TimeOnSiteTracker.prototype.getSessionDuration=function(){var a=this.getCookie(this.TOS_CONST.TOSSessionDuration);if(isNaN(a)||void 0==a||"undefined"==a||null==a||""==a){this.developerMode&&console.error("TOSSessionDuration cookie broken due to unknown reasons! Sending back safe value(numeric)");return this.getTimeOnPage().timeOnPage}return parseInt(a)},TimeOnSiteTracker.prototype.reviveBrokenSession=function(){return this.getCookie(this.TOS_CONST.TOSUserId)||this.setCookie(this.TOS_CONST.TOSSessionKey,this.TOSSessionKey,this.sessionValidity.anonymous),this.TOSSessionKey},TimeOnSiteTracker.prototype.checkBlacklistUrl=function(a){for(var b=decodeURI(document.URL),c=0;c<a.length;c++)if(a[c]===b)return!1;return!0},TimeOnSiteTracker.prototype.getPageData=function(){var a={};return a.TOSId=this.TOSId,a.TOSSessionKey=this.TOSSessionKey,a.TOSUserId=this.TOSUserId,a.URL=decodeURI(document.URL),a.title=document.title,a},TimeOnSiteTracker.prototype.getTimeOnPage=function(){var a,b=new Date,c=0;return this.timeSpentArr.length&&(this.totalTimeSpent=this.arrayAggregate(this.timeSpentArr)),c=this.returnInSeconds?this.totalTimeSpent+this.getTimeDiff(this.varyingStartTime,b)/1e3:this.totalTimeSpent+this.getTimeDiff(this.varyingStartTime,b),a=this.getPageData(),a=this.mergeCustomData(a),a.entryTime=this.pageEntryTime,a.currentTime=this.getDateTime(),a.timeOnPage=Math.round(c),a.timeOnPageTrackedBy=!0===this.returnInSeconds?"second":"millisecond",a.timeOnSite=this.timeOnSite,a.timeOnPageByDuration=!0===this.returnInSeconds?this.secondToDuration(a.timeOnPage):this.secondToDuration(this.millisecondToSecond(a.timeOnPage)),a.timeOnSiteByDuration=!0===this.returnInSeconds?this.secondToDuration(a.timeOnSite):this.secondToDuration(this.millisecondToSecond(a.timeOnSite)),a.trackingType="tos",a},TimeOnSiteTracker.prototype.mergeCustomData=function(a){if(this.customData)for(var b in this.customData)a[b]=this.customData[b];return a},TimeOnSiteTracker.prototype.setCustomData=function(a){a&&Object.keys(a).length?this.customData=a:console.warn("Custom data should be of type object!")},TimeOnSiteTracker.prototype.unsetCustomData=function(){this.customData=null},TimeOnSiteTracker.prototype.getMD5Hash=function(a){function b(a,b){return a<<b|a>>>32-b}function c(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f}function d(a,b,c){return a&b|~a&c}function e(a,b,c){return a&c|b&~c}function f(a,b,c){return a^b^c}function g(a,b,c){return b^(a|~c)}function h(a,e,f,g,h,i,j){return a=c(a,c(c(d(e,f,g),h),j)),c(b(a,i),e)}function i(a,d,f,g,h,i,j){return a=c(a,c(c(e(d,f,g),h),j)),c(b(a,i),d)}function j(a,d,e,g,h,i,j){return a=c(a,c(c(f(d,e,g),h),j)),c(b(a,i),d)}function k(a,d,e,f,h,i,j){return a=c(a,c(c(g(d,e,f),h),j)),c(b(a,i),d)}function l(a){var b,c,d="",e="";for(c=0;c<=3;c++)b=a>>>8*c&255,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d}var m,n,o,p,q,r,s,t,u,v=Array();for(a=function(a){a=a.replace(/rn/g,"n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}(a),v=function(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=Array(f-1),h=0,i=0;i<c;)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g}(a),r=1732584193,s=4023233417,t=2562383102,u=271733878,m=0;m<v.length;m+=16)n=r,o=s,p=t,q=u,r=h(r,s,t,u,v[m+0],7,3614090360),u=h(u,r,s,t,v[m+1],12,3905402710),t=h(t,u,r,s,v[m+2],17,606105819),s=h(s,t,u,r,v[m+3],22,3250441966),r=h(r,s,t,u,v[m+4],7,4118548399),u=h(u,r,s,t,v[m+5],12,1200080426),t=h(t,u,r,s,v[m+6],17,2821735955),s=h(s,t,u,r,v[m+7],22,4249261313),r=h(r,s,t,u,v[m+8],7,1770035416),u=h(u,r,s,t,v[m+9],12,2336552879),t=h(t,u,r,s,v[m+10],17,4294925233),s=h(s,t,u,r,v[m+11],22,2304563134),r=h(r,s,t,u,v[m+12],7,1804603682),u=h(u,r,s,t,v[m+13],12,4254626195),t=h(t,u,r,s,v[m+14],17,2792965006),s=h(s,t,u,r,v[m+15],22,1236535329),r=i(r,s,t,u,v[m+1],5,4129170786),u=i(u,r,s,t,v[m+6],9,3225465664),t=i(t,u,r,s,v[m+11],14,643717713),s=i(s,t,u,r,v[m+0],20,3921069994),r=i(r,s,t,u,v[m+5],5,3593408605),u=i(u,r,s,t,v[m+10],9,38016083),t=i(t,u,r,s,v[m+15],14,3634488961),s=i(s,t,u,r,v[m+4],20,3889429448),r=i(r,s,t,u,v[m+9],5,568446438),u=i(u,r,s,t,v[m+14],9,3275163606),t=i(t,u,r,s,v[m+3],14,4107603335),s=i(s,t,u,r,v[m+8],20,1163531501),r=i(r,s,t,u,v[m+13],5,2850285829),u=i(u,r,s,t,v[m+2],9,4243563512),t=i(t,u,r,s,v[m+7],14,1735328473),s=i(s,t,u,r,v[m+12],20,2368359562),r=j(r,s,t,u,v[m+5],4,4294588738),u=j(u,r,s,t,v[m+8],11,2272392833),t=j(t,u,r,s,v[m+11],16,1839030562),s=j(s,t,u,r,v[m+14],23,4259657740),r=j(r,s,t,u,v[m+1],4,2763975236),u=j(u,r,s,t,v[m+4],11,1272893353),t=j(t,u,r,s,v[m+7],16,4139469664),s=j(s,t,u,r,v[m+10],23,3200236656),r=j(r,s,t,u,v[m+13],4,681279174),u=j(u,r,s,t,v[m+0],11,3936430074),t=j(t,u,r,s,v[m+3],16,3572445317),s=j(s,t,u,r,v[m+6],23,76029189),r=j(r,s,t,u,v[m+9],4,3654602809),u=j(u,r,s,t,v[m+12],11,3873151461),t=j(t,u,r,s,v[m+15],16,530742520),s=j(s,t,u,r,v[m+2],23,3299628645),r=k(r,s,t,u,v[m+0],6,4096336452),u=k(u,r,s,t,v[m+7],10,1126891415),t=k(t,u,r,s,v[m+14],15,2878612391),s=k(s,t,u,r,v[m+5],21,4237533241),r=k(r,s,t,u,v[m+12],6,1700485571),u=k(u,r,s,t,v[m+3],10,2399980690),t=k(t,u,r,s,v[m+10],15,4293915773),s=k(s,t,u,r,v[m+1],21,2240044497),r=k(r,s,t,u,v[m+8],6,1873313359),u=k(u,r,s,t,v[m+15],10,4264355552),t=k(t,u,r,s,v[m+6],15,2734768916),s=k(s,t,u,r,v[m+13],21,1309151649),r=k(r,s,t,u,v[m+4],6,4149444226),u=k(u,r,s,t,v[m+11],10,3174756917),t=k(t,u,r,s,v[m+2],15,718787259),s=k(s,t,u,r,v[m+9],21,3951481745),r=c(r,n),s=c(s,o),t=c(t,p),u=c(u,q);return(l(r)+l(s)+l(t)+l(u)).toLowerCase()},TimeOnSiteTracker.prototype.resetActivity=function(){this.activityStartTime=this.getDateTime(),this.activity.varyingStartTime=new Date,this.activity.totalTimeSpent=0,this.activity.totalTimeSpentArr=[]},TimeOnSiteTracker.prototype.startActivity=function(a){this.resetActivity(),this.activity.activityStarted=!0,a&&Object.keys(a).length&&(this.startActivityDetails=a),this.developerMode&&console.log("Activity starts at : "+this.activity.varyingStartTime)},TimeOnSiteTracker.prototype.endActivity=function(a,b){var c={};if(this.activity.activityStarted){var d=new Date,e=0;this.activity.totalTimeSpentArr.length&&(this.activity.totalTimeSpent=this.arrayAggregate(this.activity.totalTimeSpentArr)),e=this.returnInSeconds?this.activity.totalTimeSpent+this.getTimeDiff(this.activity.varyingStartTime,d)/1e3:this.activity.totalTimeSpent+this.getTimeDiff(this.activity.varyingStartTime,d),this.developerMode&&(this.returnInSeconds?console.log("Total time spent : "+this.activity.totalTimeSpent+" in array: "+this.getTimeDiff(this.activity.varyingStartTime,d)/1e3):console.log("Total time spent : "+this.activity.totalTimeSpent+" in array: "+this.getTimeDiff(this.activity.varyingStartTime,d))),c=this.getPageData(),c.TOSId=this.createTOSId(),c.activityStart=this.activityStartTime,c.activityEnd=this.getDateTime(),c.timeTaken=Math.round(e),c.timeTakenTrackedBy=!0===this.returnInSeconds?"second":"millisecond",c.timeTakenByDuration=!0===this.returnInSeconds?this.secondToDuration(c.timeTaken):this.secondToDuration(this.millisecondToSecond(c.timeTaken));for(var f in this.startActivityDetails)c[f]=this.startActivityDetails[f];if(a&&Object.keys(a).length)for(var f in a)c[f]=a[f];c.trackingType="activity",this.activity.activityStarted=!1,this.resetActivity(),this.developerMode&&console.log("Activity ends at "+new Date),b||this.processActivityData(c)}else console.warn("Please start activity before finishing it!");return c},TimeOnSiteTracker.prototype.processActivityData=function(a){"function"==typeof this.callback?this.callback(a):this.storeInLocalStorage&&this.saveToLocalStorage(a)},TimeOnSiteTracker.prototype.fileValidation=function(){var a="undefined";void 0!==TimeOnSiteTracker&&(a="TimeOnSiteTracker"),this.getMD5Hash(a)!==this.fileIntegrityCode&&(this.developerMode=!1,this.isTimeOnSiteAllowed=!1,this.sessionStateChangeTimerId&&clearInterval(this.sessionStateChangeTimerId))},TimeOnSiteTracker.prototype.trackPageNavigation=function(){this.executeURLChangeCustoms()},TimeOnSiteTracker.prototype.isLocalStorageEnabled=function(){try{var a="___localstorage_test___";return localStorage.setItem(a,a),localStorage.removeItem(a),!0}catch(a){return!1}},TimeOnSiteTracker.prototype.handleDateKeysInit=function(){var a,b=this.getCurrentDayKey(),c=!1,d=this.TOSDateKeysHolder;if(a=localStorage.getItem(d)){for(var e=JSON.parse(a),f=0;f<e.length;f++)if(e[f]==b){c=!0;break}c||(e.push(b),localStorage.setItem(d,JSON.stringify(e)))}else a=[],a.push(b),localStorage.setItem(d,JSON.stringify(a))},TimeOnSiteTracker.prototype.saveToLocalStorage=function(a){if(this.storageSupported){this.handleDateKeysInit();var b=this.getCurrentDayKey(),c=localStorage.getItem(b);if(c){var d=JSON.parse(c);d.push(a),localStorage.setItem(b,JSON.stringify(d))}else{var e=[];e.push(a),localStorage.setItem(b,JSON.stringify(e))}}else console.warn("Local storage not supported for TimeOnSite tracking!")},TimeOnSiteTracker.prototype.upsertToLocalStorageIOS=function(a){if(this.storageSupported){if(!1===document.hasFocus())return;var b=this.getCurrentDayKey();a.lastUpdatedTimeStamp=new Date;var c=localStorage.getItem(b);if(c){var d=JSON.parse(c);console.log("IOS: existing data"),console.log(JSON.stringify(d)),console.error("IOS: *** currentSessionIOSRecentData ***"),console.error(a);for(var e=0;e<d.length;e++)a.TOSId==d[e].TOSId&&a.TOSSessionKey===d[e].TOSSessionKey&&(console.error("IOS: Existing....TOSId : "+a.TOSId+", TOSSessionKey : "+a.TOSSessionKey+", Index position : "+e),d[e]=a,localStorage.setItem(b,JSON.stringify(d)));for(var f=!0,e=0;e<d.length;e++)if(a.TOSId===d[e].TOSId){f=!1;break}!0===f&&d.length>=1&&a.TOSSessionKey===this.getRecentSessionKeyIOS()&&(console.error("IOS: Same SESSION TOSSessionKey : "+a.TOSSessionKey+", new PageRefresh/tab TOSId : "+a.TOSId),d.push(a),localStorage.setItem(b,JSON.stringify(d)));for(var g=!0,e=0;e<d.length;e++)a.TOSSessionKey===d[e].TOSSessionKey&&(g=!1);!0===g&&(d.push(a),console.error("IOS: New session found for current day given LS already has length>=1 !"),localStorage.setItem(b,JSON.stringify(d)))}else{var h=[];h.push(a),console.log("IOS: first time data push in current date, data is :"),console.log(JSON.stringify(h)),localStorage.setItem(b,JSON.stringify(h))}this.updateCurrentSessionLocalStorageIOS()}else console.warn("IOS: Local storage not supported for TimeOnSite tracking!")},TimeOnSiteTracker.prototype.flushDemoDataIOS=function(){if(this.isFlushSampleDataIOS){for(var a=this.TOSDateKeysHolder,b=this.getDateKeys(),c=this.getCurrentDayKey(),d=0;d<b.length;d++)b[d]!=c&&(console.warn("IOS: Demo Deleted Date item!"),console.warn(localStorage.getItem(b[d])),localStorage.removeItem(b[d]),console.warn("IOS: Demo Deleted Date Key!"),console.warn(b[d]),b.splice(d,1));localStorage.setItem(a,JSON.stringify(b)),console.warn("IOS: Demo Updated Date Key Array after flush operation!"),console.warn(localStorage.getItem(a))}},TimeOnSiteTracker.prototype.getTimeOnSiteCurrentSessionIOS=function(){var a,b=this.getCurrentDayKey(),c=0,d=localStorage.getItem(b);if(d&&(a=JSON.parse(d)),a&&a.length&&this.TOSSessionKey)for(var e=0;e<a.length;e++)"tos"===a[e].trackingType&&this.TOSSessionKey===a[e].TOSSessionKey&&(c+=a[e].timeOnPage);else console.error("IOS: No current session data in Localstorage; or empty sessionKey : "+this.TOSSessionKey+" returning 0 as timeOnSite!");return c},TimeOnSiteTracker.prototype.updateCurrentSessionLocalStorageIOS=function(){var a=this.getCurrentDayKey(),b=localStorage.getItem(a);if(b){var c=JSON.parse(b),d=[],e=0;if(c&&c.length&&this.TOSSessionKey){for(var f=0;f<c.length;f++)"tos"===c[f].trackingType&&this.TOSSessionKey===c[f].TOSSessionKey&&(d.push(c[f].TOSId),e+=c[f].timeOnPage,c[f].timeOnSite=e,c[f].timeOnSiteByDuration=!0===this.returnInSeconds?this.secondToDuration(e):this.secondToDuration(this.millisecondToSecond(e)));console.error("IOS: Current session's active TOSId to spearhead timeonsite...."),console.error(d)}for(var f=0;f<c.length;f++)if("tos"===c[f].trackingType&&this.TOSSessionKey===c[f].TOSSessionKey){var g=new Date,h=new Date(c[f].lastUpdatedTimeStamp);if(console.error("IOS: Timestamp diffence value for TOSId: "+c[f].TOSId+" : at index: "+f+" is "+parseInt(g/1e3-h/1e3)),parseInt(g/1e3-h/1e3)<5){console.error(c[f].TOSId+" updates the LS and breaks the loop"),localStorage.setItem(a,JSON.stringify(c)),console.log("IOS: Updated data"),console.log(JSON.stringify(c));break}}}},TimeOnSiteTracker.prototype.getRecentSessionKeyIOS=function(){var a=this.getCurrentDayKey(),b=localStorage.getItem(a),c=JSON.parse(b),d=[],e="";if(c&&c.length){for(var f=0;f<c.length;f++)"tos"===c[f].trackingType&&d.push(c[f]);var g=d.length;1===g?e=d[0].TOSSessionKey:g>1&&(e=d[g-1].TOSSessionKey)}return console.error("IOS: Most recent session key : "+e),e},TimeOnSiteTracker.prototype.getCurrentDayKey=function(){var a=new Date;return this.TOSDayKeyPrefix+(a.getMonth()+1)+"_"+a.getDate()+"_"+a.getFullYear()},TimeOnSiteTracker.prototype.processDataInLocalStorage=function(){var a=this.getDateKeys();if(a instanceof Array&&a.length){var b=a[0];this.developerMode&&console.log("Current date key to process in storage: "+b);var c=localStorage.getItem(b);if(c){var d=JSON.parse(c);d instanceof Array&&d.length&&this.sendData(b,d)}}},TimeOnSiteTracker.prototype.getDateKeys=function(){var a=[];if(this.storageSupported){var b=this.TOSDateKeysHolder,c=localStorage.getItem(b);c&&(a=JSON.parse(c))}return a},TimeOnSiteTracker.prototype.removeDateKey=function(a){var b=this.TOSDateKeysHolder,c=this.getDateKeys();if(this.storageSupported&&c instanceof Array&&c.length)for(var d=0;d<c.length;d++)c[d]==a&&(c.splice(d,1),localStorage.removeItem(a),localStorage.setItem(b,JSON.stringify(c)),c.length&&this.processDataInLocalStorage())},TimeOnSiteTracker.prototype.updateStorageData=function(a,b){var c=this;b.shift(),this.developerMode&&console.log("Records count is : "+b.length),b.length?(localStorage.setItem(a,JSON.stringify(b)),setTimeout(function(){c.sendData(a,b)},500)):this.removeDateKey(a)},TimeOnSiteTracker.prototype.verifyData=function(a){var b=!1;return a.TOSSessionKey&&a.TOSSessionKey.length||(b=!0,this.developerMode&&console.error("TOSSessionKey invalid : "+a.TOSSessionKey)),"number"==typeof a.timeOnPage&&"number"==typeof a.timeOnSite||(b=!0,this.developerMode&&console.error("timeOnPage/timeOnSite invalid. timeOnPage : "+a.timeOnPage+" & timeOnSite : "+a.timeOnSite)),a.entryTime&&a.entryTime.length||(b=!0,this.developerMode&&console.error("Entry time invalid: "+a.entryTime)),a.exitTime&&a.exitTime.length||(b=!0,this.developerMode&&console.error("Exit time invalid: "+a.exitTime)),b?(this.developerMode&&console.error(a),"invalid"):"valid"},TimeOnSiteTracker.prototype.isProcessingAllowedIOS=function(a,b){console.error("itemData[0].TOSSessionKey: "+b[0].TOSSessionKey),console.error("currentSessionKey: "+this.getCookie(this.TOS_CONST.TOSSessionKey));var c=this,d=this.getCookie(this.TOS_CONST.TOSSessionKey);return"tos"===b[0].trackingType&&d&&b[0].TOSSessionKey===d?(console.error("IOS: Block 1, not allowed to proceed now but later on because same session!"),!1):!!d||(console.error("IOS: Block 2, not allowed to proceed now but later on because either session cookie not initiated!"),setTimeout(function(){c.sendData(a,b)},2e3),!1)},TimeOnSiteTracker.prototype.sendData=function(a,b){var c=this.request.url,d=b[0],e=this;if("tos"==b[0].trackingType&&"valid"!=this.verifyData(b[0]))return this.updateStorageData(a,b),!1;if(this.isIOS()){if(!1===this.isProcessingAllowedIOS(a,b))return!1;console.error("IOS: Block safe, Allowed to proceed further now & save in DB!"),delete d.lastUpdatedTimeStamp}if(this.xhr=null,window.XMLHttpRequest?this.xhr=new XMLHttpRequest:this.xhr=new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.open("POST",c,!0),this.xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),this.xhr.setRequestHeader("cache-control","no-cache"),this.isRequestHeadersAvailable&&this.request.headers.length)for(var f=0;f<this.request.headers.length;f++){var g=this.request.headers[f];for(var h in g)this.xhr.setRequestHeader(h,g[h])}this.xhr.onreadystatechange=function(){4==e.xhr.readyState&&200==e.xhr.status&&"success"==e.xhr.responseText&&e.updateStorageData(a,b)},d=JSON.stringify(d),this.xhr.send(d)},TimeOnSiteTracker.prototype.bindWindowFocus=function(){var a,b,c,d=this;void 0!==document.hidden?(a="hidden",c="visibilitychange",b="visibilityState"):void 0!==document.mozHidden?(a="mozHidden",c="mozvisibilitychange",b="mozVisibilityState"):void 0!==document.msHidden?(a="msHidden",c="msvisibilitychange",b="msVisibilityState"):void 0!==document.webkitHidden&&(a="webkitHidden",c="webkitvisibilitychange",b="webkitVisibilityState"),void 0===document.addEventListener||void 0===a?console.warn("Page visisbility API not supported in this browser which may result in less accuracy in TOS tracking!"):document.addEventListener(c,function(){if("visible"==document[b])d.varyingStartTime=new Date,d.totalTimeSpent=d.arrayAggregate(d.timeSpentArr),d.developerMode&&(console.log("On visible state"),console.log("Time spent on SITE so far : "+d.totalTimeSpent)),d.activity.activityStarted&&(d.activity.varyingStartTime=new Date,d.activity.totalTimeSpent=d.arrayAggregate(d.activity.totalTimeSpentArr),d.developerMode&&console.log("Time spent on ACTIVITY so far : "+d.activity.totalTimeSpent));else if("hidden"==document[b]){d.developerMode&&(console.log("On invisible state, accumulated data array for TimeOnSite:"),console.log(d.timeSpentArr));var a=new Date;d.returnInSeconds?d.timeSpentArr.push(d.getTimeDiff(d.varyingStartTime,a)/1e3):d.timeSpentArr.push(d.getTimeDiff(d.varyingStartTime,a)),d.activity.activityStarted&&(d.developerMode&&(console.log("On invisible state, accumulated data array for activity:"),console.log(d.activity.totalTimeSpentArr)),d.returnInSeconds?d.activity.totalTimeSpentArr.push(d.getTimeDiff(d.activity.varyingStartTime,a)/1e3):d.activity.totalTimeSpentArr.push(d.getTimeDiff(d.activity.varyingStartTime,a)))}d.developerMode&&console.log('Tracked by "SECONDS": '+d.returnInSeconds)},!1)},TimeOnSiteTracker.prototype.setCookie=function(a,b,c){var d,e,f=new Date;f.setTime(f.getTime()+1e3*c),d="expires="+f.toUTCString(),e=a+"="+b+"; "+d+"; "+this.TOSCookie.customCookieString,document.cookie=e},TimeOnSiteTracker.prototype.getCookie=function(a){var b,c=document.cookie.split(";");b=a+"=";for(var d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return""},TimeOnSiteTracker.prototype.removeCookie=function(a){this.getCookie(a)&&(document.cookie=a+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; "+this.TOSCookie.customCookieString)},TimeOnSiteTracker.prototype.bindWindowHistory=function(){var a=this;if(window.history&&window.history.pushState)!function(a){var b=a.pushState;a.pushState=function(c){return"function"==typeof a.onpushstate&&a.onpushstate({state:c}),b.apply(a,arguments)}}(window.history),window.onpopstate=history.onpushstate=function(b){setTimeout(function(){a.developerMode&&console.info("URL changes via window history API!"),a.executeURLChangeCustoms()},100)};else{var b=function(){this.oldHash=window.location.hash;var b=this,c=function(){b.oldHash!=window.location.hash&&(b.oldHash=window.location.hash,a.developerMode&&console.info("URL changes via location.hash!"),a.executeURLChangeCustoms())};setInterval(function(){c()},100)};new b}},TimeOnSiteTracker.prototype.executeURLChangeCustoms=function(){this.monitorSession(),this.processTOSData()},TimeOnSiteTracker.prototype.bindWindowUnload=function(){var a=this;(window.attachEvent||window.addEventListener)(window.attachEvent?"onbeforeunload":"beforeunload",function(b){void 0===b&&(b=window.event),b&&(a.monitorSession(),a.processTOSData())})},
TimeOnSiteTracker.prototype.processTOSData=function(){this.developerMode&&console.log("Time at exit: "+new Date);var a=this.getTimeOnPage();a.exitTime=this.getDateTime(),this.isTimeOnSiteAllowed&&("function"==typeof this.callback?this.callback(a):this.storeInLocalStorage&&(this.isIOS()?this.upsertToLocalStorageIOS(a):this.saveToLocalStorage(a))),this.varyingStartTime=new Date,this.pageEntryTime=this.getDateTime(),this.totalTimeSpent=0,this.timeSpentArr=[],!0===this.config.trackHistoryChange&&(this.TOSId=this.createTOSId()),this.activity.activityStarted&&(this.activity.activityStarted=!1,this.resetActivity())};